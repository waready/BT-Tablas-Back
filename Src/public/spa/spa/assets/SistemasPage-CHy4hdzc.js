import{_ as V,U as m,N as u,V as l,Q as n,W as c,R as o,X as g,Y as p,Z as b,$ as y,a0 as I,a1 as C,a2 as v,a3 as w}from"./index-DqHQfiAV.js";import{Q as D}from"./QTd-D2DHilPY.js";import{Q as E}from"./QTable-m3-nAVvW.js";import{Q as _}from"./QPage-wB-Hzf8W.js";import{A as h}from"./ApiService-BKWcok9t.js";import"./position-engine-KsekyXtm.js";import"./axios-DFFzlOS1.js";const f={CREATE:"sistemas.create",UPDATE:"sistemas.update",DELETE:"sistemas.delete"},N={name:"SistemasPage",data(){return{auth:w(),sistemas:[],loading:!0,saving:!1,deleting:!1,pagination:{page:1,rowsPerPage:10,sortBy:"id",descending:!1,rowsNumber:0},search:"",dialogVisible:!1,deleteDialogVisible:!1,currentItem:{},itemToDelete:null,columns:[{name:"cod_area_funcional",label:"Código Área Funcional",field:"cod_area_funcional",align:"left",sortable:!0},{name:"cod_sistema",label:"Código Sistema",field:"cod_sistema",align:"left",sortable:!0},{name:"corr",label:"Correlativo",field:"corr",align:"left",sortable:!0},{name:"sistema",label:"Sistema",field:"sistema",align:"left",sortable:!0},{name:"actions",label:"Acciones",field:"actions",align:"center"}]}},computed:{permSet(){const t=this.auth?.permissions||[];console.log("Auth permissions:",t);const e=t.map(s=>typeof s=="string"?s:s?.description).filter(Boolean);return console.log("Computed permSet:",e),new Set(e)},isAdmin(){return(this.auth?.roles||[]).some(e=>typeof e=="string"?e==="admin":(e?.code||e?.name||e?.nombre)==="admin")},canCreate(){return this.isAdmin||this.permSet.has(f.CREATE)},canUpdate(){return this.isAdmin||this.permSet.has(f.UPDATE)},canDelete(){return this.isAdmin||this.permSet.has(f.DELETE)},canSaveDialog(){return!!this.currentItem?.id?this.canUpdate:this.canCreate},columnsSafe(){return this.canUpdate||this.canDelete?this.columns:(this.columns||[]).filter(t=>t.name!=="actions")}},mounted(){this.fetchSistemas()},watch:{search(){this.pagination.page=1,this.fetchSistemas()}},methods:{isRequired(t){return!!(t&&String(t).trim())||"Este campo es obligatorio"},isInt(t){return Number.isInteger(Number(t))?!0:"Ingrese un entero válido"},deny(){v.create({type:"negative",message:"No tienes permisos para esta acción."})},capLimit(t,e=100){const s=Number(t);return!Number.isFinite(s)||s<=0?10:Math.min(s,e)},async fetchSistemas(){this.loading=!0;try{const t=this.capLimit(this.pagination.rowsPerPage,100),e={page:this.pagination.page,limit:t,sortBy:this.pagination.sortBy||"id",order:this.pagination.descending?"desc":"asc",search:this.search},s=await h.GetSistemas(e);this.sistemas=Array.isArray(s.items)?s.items:[],this.pagination.rowsNumber=Number(s.total)||0,s.page&&(this.pagination.page=Number(s.page)),s.limit&&(this.pagination.rowsPerPage=Number(s.limit))}catch(t){console.error("Error al obtener los sistemas:",t),this.$q?.notify?.({type:"negative",message:"No se pudieron cargar los sistemas"}),this.sistemas=[],this.pagination.rowsNumber=0}finally{this.loading=!1}},onRequest({pagination:t}){const{page:e,rowsPerPage:s,sortBy:d,descending:i}=t;this.pagination.page=e,this.pagination.rowsPerPage=s,this.pagination.sortBy=d,this.pagination.descending=i,this.fetchSistemas()},onSearch(){this.pagination.page=1,this.fetchSistemas()},openCreateDialog(){if(!this.canCreate)return this.deny();this.currentItem={cod_area_funcional:null,cod_sistema:null,corr:null,sistema:""},this.dialogVisible=!0},openEditDialog(t){if(!this.canUpdate)return this.deny();this.currentItem={id:t.id,cod_area_funcional:Number(t.cod_area_funcional),cod_sistema:Number(t.cod_sistema),corr:Number(t.corr),sistema:(t.sistema||"").trim()},this.dialogVisible=!0},async saveItem(){const t=!!this.currentItem?.id;if(!t&&!this.canCreate)return this.deny();if(t&&!this.canUpdate)return this.deny();this.saving=!0;try{const e=this.isInt(this.currentItem.cod_area_funcional);if(e!==!0)throw new Error(e);const s=this.isInt(this.currentItem.cod_sistema);if(s!==!0)throw new Error(s);const d=this.isInt(this.currentItem.corr);if(d!==!0)throw new Error(d);const i=this.isRequired(this.currentItem.sistema);if(i!==!0)throw new Error(i);const r={cod_area_funcional:Number(this.currentItem.cod_area_funcional),cod_sistema:Number(this.currentItem.cod_sistema),corr:Number(this.currentItem.corr),sistema:(this.currentItem.sistema||"").trim()};this.currentItem.id?await h.SetSistemas(this.currentItem.id,r):await h.CreateSistemas(r),this.dialogVisible=!1,this.fetchSistemas(),this.$q?.notify?.({type:"positive",message:"Sistema guardado"})}catch(e){console.error("Error al guardar el sistema:",e);const s=e?.response?.data?.message||e.message||"Error al guardar";this.$q?.notify?.({type:"negative",message:s})}finally{this.saving=!1}},confirmDelete(t){if(!this.canDelete)return this.deny();this.itemToDelete=t,this.deleteDialogVisible=!0},async deleteItem(){if(!this.canDelete)return this.deny();this.deleting=!0;try{await h.DeleteSistemas(this.itemToDelete),this.deleteDialogVisible=!1,this.fetchSistemas(),this.$q?.notify?.({type:"positive",message:"Sistema eliminado"})}catch(t){console.error("Error al eliminar el sistema:",t),this.$q?.notify?.({type:"negative",message:"No se pudo eliminar"})}finally{this.deleting=!1}}}};function k(t,e,s,d,i,r){return u(),m(_,{class:"q-pa-md"},{default:l(()=>[n(E,{rows:i.sistemas||[],columns:r.columnsSafe,"row-key":"id",loading:i.loading,pagination:i.pagination,"onUpdate:pagination":e[1]||(e[1]=a=>i.pagination=a),"rows-per-page-options":[10,25,50,100],"rows-per-page-label":"Registros por página:","no-data-label":"Sin datos","no-results-label":"Sin resultados",onRequest:r.onRequest,class:"q-mb-md"},{"top-left":l(()=>[r.canCreate?(u(),m(o,{key:0,label:"Crear Nuevo Sistema",color:"secondary",onClick:r.openCreateDialog,rounded:""},null,8,["onClick"])):c("",!0)]),"top-right":l(()=>[n(g,{filled:"",dense:"",debounce:"300",placeholder:"Buscar...",modelValue:i.search,"onUpdate:modelValue":e[0]||(e[0]=a=>i.search=a),onInput:r.onSearch,clearable:""},null,8,["modelValue","onInput"])]),"body-cell-actions":l(a=>[n(D,{props:a,class:"q-pa-none"},{default:l(()=>[r.canUpdate?(u(),m(o,{key:0,flat:"",color:"secondary",icon:"edit",onClick:S=>r.openEditDialog(a.row),class:"q-mr-xs",round:""},null,8,["onClick"])):c("",!0),r.canDelete?(u(),m(o,{key:1,flat:"",color:"negative",icon:"delete",onClick:S=>r.confirmDelete(a.row.id),round:""},null,8,["onClick"])):c("",!0)]),_:2},1032,["props"])]),_:1},8,["rows","columns","loading","pagination","onRequest"]),n(p,{modelValue:i.dialogVisible,"onUpdate:modelValue":e[8]||(e[8]=a=>i.dialogVisible=a)},{default:l(()=>[n(b,{class:"q-pa-md",style:{width:"400px"}},{default:l(()=>[n(y,{class:"q-gutter-sm"},{default:l(()=>[n(g,{modelValue:i.currentItem.cod_area_funcional,"onUpdate:modelValue":e[2]||(e[2]=a=>i.currentItem.cod_area_funcional=a),modelModifiers:{number:!0},type:"number",label:"Código Área Funcional",outlined:"",rules:[r.isInt]},null,8,["modelValue","rules"]),n(g,{modelValue:i.currentItem.cod_sistema,"onUpdate:modelValue":e[3]||(e[3]=a=>i.currentItem.cod_sistema=a),modelModifiers:{number:!0},type:"number",label:"Código Sistema",outlined:"",rules:[r.isInt]},null,8,["modelValue","rules"]),n(g,{modelValue:i.currentItem.corr,"onUpdate:modelValue":e[4]||(e[4]=a=>i.currentItem.corr=a),modelModifiers:{number:!0},type:"number",label:"Correlativo",outlined:"",rules:[r.isInt]},null,8,["modelValue","rules"]),n(g,{modelValue:i.currentItem.sistema,"onUpdate:modelValue":[e[5]||(e[5]=a=>i.currentItem.sistema=a),e[6]||(e[6]=a=>i.currentItem.sistema=(a||"").trim())],label:"Sistema",outlined:"",rules:[r.isRequired]},null,8,["modelValue","rules"])]),_:1}),n(I,{align:"right"},{default:l(()=>[r.canSaveDialog?(u(),m(o,{key:0,onClick:r.saveItem,color:"primary",label:"Guardar",loading:i.saving},null,8,["onClick","loading"])):c("",!0),n(o,{flat:"",onClick:e[7]||(e[7]=a=>i.dialogVisible=!1),color:"secondary",label:"Cancelar"})]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(p,{modelValue:i.deleteDialogVisible,"onUpdate:modelValue":e[10]||(e[10]=a=>i.deleteDialogVisible=a)},{default:l(()=>[n(b,{class:"q-pa-md"},{default:l(()=>[n(y,null,{default:l(()=>[...e[11]||(e[11]=[C("¿Estás seguro que deseas eliminar este sistema?",-1)])]),_:1}),n(I,{align:"right"},{default:l(()=>[r.canDelete?(u(),m(o,{key:0,onClick:r.deleteItem,color:"negative",label:"Eliminar",loading:i.deleting},null,8,["onClick","loading"])):c("",!0),n(o,{flat:"",onClick:e[9]||(e[9]=a=>i.deleteDialogVisible=!1),color:"secondary",label:"Cancelar"})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const B=V(N,[["render",k],["__scopeId","data-v-88ea5d9d"]]);export{B as default};
