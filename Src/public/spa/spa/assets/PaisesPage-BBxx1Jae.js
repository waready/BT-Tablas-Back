import{_ as V,U as d,N as u,V as r,Q as n,W as c,R as l,X as p,Y as f,Z as b,$ as y,a0 as C,a1 as D,a2 as E,a3 as I}from"./index-DoNdm23b.js";import{Q as w}from"./QTd-BVHgFqKU.js";import{Q as v}from"./QTable-BBpWQ1VS.js";import{Q as S}from"./QPage-D4RWoOZ7.js";import{A as g}from"./ApiService-D_JDuaKY.js";import"./position-engine-C0na6ooX.js";import"./axios-BXLeQQ8K.js";const h={CREATE:"paises.create",UPDATE:"paises.update",DELETE:"paises.delete"},k={name:"PaisesPage",data(){return{auth:I(),paises:[],loading:!0,saving:!1,deleting:!1,pagination:{page:1,rowsPerPage:10,sortBy:"id",descending:!1,rowsNumber:0},search:"",dialogVisible:!1,deleteDialogVisible:!1,currentItem:{},itemToDelete:null,columns:[{name:"nombre",label:"Nombre",field:"nombre",align:"left",sortable:!0},{name:"isoCode",label:"Código ISO",field:t=>t.isoCode??"—",align:"left",sortable:!0},{name:"actions",label:"Acciones",field:"actions",align:"center"}]}},computed:{permSet(){const e=(this.auth?.permissions||[]).map(i=>typeof i=="string"?i:i?.code||i?.name||i?.nombre).filter(Boolean);return new Set(e)},isAdmin(){return(this.auth?.roles||[]).some(e=>typeof e=="string"?e==="admin":(e?.code||e?.name||e?.nombre)==="admin")},canCreate(){return this.isAdmin||this.permSet.has(h.CREATE)},canUpdate(){return this.isAdmin||this.permSet.has(h.UPDATE)},canDelete(){return this.isAdmin||this.permSet.has(h.DELETE)},canSaveDialog(){return!!this.currentItem?.id?this.canUpdate:this.canCreate},columnsSafe(){return this.canUpdate||this.canDelete?this.columns:(this.columns||[]).filter(t=>t.name!=="actions")}},mounted(){this.fetchPaises()},watch:{search(){this.pagination.page=1,this.fetchPaises()}},methods:{deny(){E.create({type:"negative",message:"No tienes permisos para esta acción."})},formatIso(t){return String(t||"").toUpperCase().replace(/[^A-Z]/g,"").slice(0,3)},capLimit(t,e=100){const i=Number(t);return!Number.isFinite(i)||i<=0?10:Math.min(i,e)},async fetchPaises(){this.loading=!0;try{const t=this.capLimit(this.pagination.rowsPerPage,100),e={page:this.pagination.page,limit:t,sortBy:this.pagination.sortBy||"id",order:this.pagination.descending?"desc":"asc",search:this.search},i=await g.GetPaises(e);this.paises=Array.isArray(i.items)?i.items:[],this.pagination.rowsNumber=Number(i.total)||0,i.page&&(this.pagination.page=Number(i.page)),i.limit&&(this.pagination.rowsPerPage=Number(i.limit))}catch(t){console.error("Error al obtener los países:",t),this.$q?.notify?.({type:"negative",message:"No se pudieron cargar los países"}),this.paises=[],this.pagination.rowsNumber=0}finally{this.loading=!1}},onRequest({pagination:t}){const{page:e,rowsPerPage:i,sortBy:m,descending:a}=t;this.pagination.page=e,this.pagination.rowsPerPage=i,this.pagination.sortBy=m,this.pagination.descending=a,this.fetchPaises()},onSearch(){this.pagination.page=1,this.fetchPaises()},openCreateDialog(){if(!this.canCreate)return this.deny();this.currentItem={nombre:"",isoCode:""},this.dialogVisible=!0},openEditDialog(t){if(!this.canUpdate)return this.deny();this.currentItem={id:t.id,nombre:t.nombre||"",isoCode:this.formatIso(t.isoCode||"")},this.dialogVisible=!0},async saveItem(){const t=!!this.currentItem?.id;if(!t&&!this.canCreate)return this.deny();if(t&&!this.canUpdate)return this.deny();this.saving=!0;try{const e=(this.currentItem.nombre||"").trim();if(!e)throw new Error("El nombre es obligatorio");const i=this.formatIso(this.currentItem.isoCode),m={nombre:e,isoCode:i.length?i:null};this.currentItem.id?await g.SetPaises(this.currentItem.id,m):await g.CreatePaises(m),this.dialogVisible=!1,this.fetchPaises(),this.$q?.notify?.({type:"positive",message:"País guardado"})}catch(e){console.error("Error al guardar el país:",e);const i=e?.response?.data?.message||e.message||"Error al guardar";this.$q?.notify?.({type:"negative",message:i})}finally{this.saving=!1}},confirmDelete(t){if(!this.canDelete)return this.deny();this.itemToDelete=t,this.deleteDialogVisible=!0},async deleteItem(){if(!this.canDelete)return this.deny();this.deleting=!0;try{await g.DeletePaises(this.itemToDelete),this.deleteDialogVisible=!1,this.fetchPaises(),this.$q?.notify?.({type:"positive",message:"País eliminado"})}catch(t){console.error("Error al eliminar el país:",t),this.$q?.notify?.({type:"negative",message:"No se pudo eliminar"})}finally{this.deleting=!1}}}};function N(t,e,i,m,a,o){return u(),d(S,{class:"q-pa-md"},{default:r(()=>[n(v,{rows:a.paises||[],columns:o.columnsSafe,"row-key":"id",loading:a.loading,pagination:a.pagination,"onUpdate:pagination":e[1]||(e[1]=s=>a.pagination=s),"rows-per-page-options":[10,25,50,100],"rows-per-page-label":"Registros por página:","no-data-label":"Sin datos","no-results-label":"Sin resultados",onRequest:o.onRequest,class:"q-mb-md"},{"top-left":r(()=>[o.canCreate?(u(),d(l,{key:0,label:"Crear Nuevo País",color:"secondary",onClick:o.openCreateDialog,rounded:""},null,8,["onClick"])):c("",!0)]),"top-right":r(()=>[n(p,{filled:"",dense:"",debounce:"300",placeholder:"Buscar...",modelValue:a.search,"onUpdate:modelValue":e[0]||(e[0]=s=>a.search=s),onInput:o.onSearch,clearable:""},null,8,["modelValue","onInput"])]),"body-cell-actions":r(s=>[n(w,{props:s,class:"q-pa-none"},{default:r(()=>[o.canUpdate?(u(),d(l,{key:0,flat:"",color:"secondary",icon:"edit",onClick:P=>o.openEditDialog(s.row),class:"q-mr-xs",round:""},null,8,["onClick"])):c("",!0),o.canDelete?(u(),d(l,{key:1,flat:"",color:"negative",icon:"delete",onClick:P=>o.confirmDelete(s.row.id),round:""},null,8,["onClick"])):c("",!0)]),_:2},1032,["props"])]),_:1},8,["rows","columns","loading","pagination","onRequest"]),n(f,{modelValue:a.dialogVisible,"onUpdate:modelValue":e[6]||(e[6]=s=>a.dialogVisible=s)},{default:r(()=>[n(b,{class:"q-pa-md",style:{width:"520px"}},{default:r(()=>[n(y,null,{default:r(()=>[n(p,{modelValue:a.currentItem.nombre,"onUpdate:modelValue":e[2]||(e[2]=s=>a.currentItem.nombre=s),label:"Nombre del País",outlined:"",rules:[s=>!!(s&&s.trim())||"El nombre es obligatorio"]},null,8,["modelValue","rules"]),n(p,{modelValue:a.currentItem.isoCode,"onUpdate:modelValue":[e[3]||(e[3]=s=>a.currentItem.isoCode=s),e[4]||(e[4]=s=>a.currentItem.isoCode=o.formatIso(s))],label:"Código ISO (2–3 letras, opcional)",outlined:"",counter:"",maxlength:"3","input-class":"text-uppercase",rules:[s=>!s||/^[A-Z]{2,3}$/.test(s)||"Use 2 o 3 letras, ej: PE o PER"]},null,8,["modelValue","rules"])]),_:1}),n(C,{align:"right"},{default:r(()=>[o.canSaveDialog?(u(),d(l,{key:0,onClick:o.saveItem,color:"primary",label:"Guardar",loading:a.saving},null,8,["onClick","loading"])):c("",!0),n(l,{flat:"",onClick:e[5]||(e[5]=s=>a.dialogVisible=!1),color:"secondary",label:"Cancelar"})]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(f,{modelValue:a.deleteDialogVisible,"onUpdate:modelValue":e[8]||(e[8]=s=>a.deleteDialogVisible=s)},{default:r(()=>[n(b,{class:"q-pa-md"},{default:r(()=>[n(y,null,{default:r(()=>[...e[9]||(e[9]=[D("¿Estás seguro de que deseas eliminar este país?",-1)])]),_:1}),n(C,{align:"right"},{default:r(()=>[o.canDelete?(u(),d(l,{key:0,onClick:o.deleteItem,color:"negative",label:"Eliminar",loading:a.deleting},null,8,["onClick","loading"])):c("",!0),n(l,{flat:"",onClick:e[7]||(e[7]=s=>a.deleteDialogVisible=!1),color:"secondary",label:"Cancelar"})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const x=V(k,[["render",N],["__scopeId","data-v-b0971527"]]);export{x as default};
